// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://tgbfqcbqfdzrtbtlycve.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnYmZxY2JxZmR6cnRidGx5Y3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NzU4ODUsImV4cCI6MjA3OTE1MTg4NX0.Z0BN652DB2byne5eOZB5Qj6dFX_Lhxm_Yj-C0MiFTYw";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
  }
});

// Health check to ensure auth is ready before critical operations
export const waitForAuth = async (maxWait = 3000): Promise<boolean> => {
  const startTime = Date.now();
  console.log('[SupabaseClient] ‚è≥ Waiting for auth to be ready...');
  
  while (Date.now() - startTime < maxWait) {
    const { data: { session } } = await supabase.auth.getSession();
    if (session?.access_token) {
      console.log('[SupabaseClient] ‚úÖ Auth ready with valid token');
      return true;
    }
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  console.warn('[SupabaseClient] ‚ö†Ô∏è Auth timeout - no valid token after', maxWait, 'ms');
  return false;
};

/**
 * Ensures there's a valid session, refreshing if necessary
 */
export const ensureValidSession = async (): Promise<boolean> => {
  console.log('[SupabaseClient] Verificando validade da sess√£o...');
  
  const { data: { session }, error } = await supabase.auth.getSession();
  
  if (error) {
    console.error('[SupabaseClient] ‚ùå Erro ao obter sess√£o:', error);
    return false;
  }
  
  if (!session) {
    console.warn('[SupabaseClient] ‚ö†Ô∏è Sem sess√£o ativa');
    return false;
  }
  
  // Check if token is close to expiring (less than 5 minutes)
  const expiresAt = session.expires_at ? session.expires_at * 1000 : 0;
  const now = Date.now();
  const fiveMinutes = 5 * 60 * 1000;
  
  if (expiresAt - now < fiveMinutes) {
    console.log('[SupabaseClient] üîÑ Token pr√≥ximo de expirar, renovando...');
    
    const { data: { session: newSession }, error: refreshError } = 
      await supabase.auth.refreshSession();
    
    if (refreshError || !newSession) {
      console.error('[SupabaseClient] ‚ùå Falha ao renovar sess√£o');
      return false;
    }
    
    console.log('[SupabaseClient] ‚úÖ Sess√£o renovada com sucesso');
    return true;
  }
  
  console.log('[SupabaseClient] ‚úÖ Sess√£o v√°lida');
  return true;
};

/**
 * Verifica se auth.uid() retorna um valor v√°lido
 * Testa ANTES de fazer opera√ß√µes cr√≠ticas com RLS
 */
export const verifyAuthUid = async (): Promise<{ valid: boolean; uid: string | null }> => {
  try {
    console.log('[SupabaseClient] üîç Testando auth.uid()...');
    
    // Usar a fun√ß√£o SQL que criamos para testar auth.uid()
    const { data, error } = await supabase
      .rpc('get_current_user_id');
    
    if (error) {
      console.error('[SupabaseClient] ‚ùå Erro ao testar auth.uid():', error);
      return { valid: false, uid: null };
    }
    
    if (!data) {
      console.warn('[SupabaseClient] ‚ö†Ô∏è auth.uid() retornou NULL');
      return { valid: false, uid: null };
    }
    
    console.log('[SupabaseClient] ‚úÖ auth.uid() v√°lido:', data);
    return { valid: true, uid: data };
  } catch (error) {
    console.error('[SupabaseClient] ‚ùå Exce√ß√£o ao testar auth.uid():', error);
    return { valid: false, uid: null };
  }
};

/**
 * For√ßa o Supabase client a recarregar o token do localStorage
 */
export const forceTokenReload = async (): Promise<boolean> => {
  try {
    console.log('[SupabaseClient] üîÑ For√ßando reload do token...');
    
    // Pegar o token do localStorage
    const storageKey = `sb-${SUPABASE_URL.split('//')[1].split('.')[0]}-auth-token`;
    const storedSession = localStorage.getItem(storageKey);
    
    if (!storedSession) {
      console.error('[SupabaseClient] ‚ùå Nenhum token no localStorage');
      return false;
    }
    
    // For√ßar o Supabase client a usar a sess√£o armazenada
    const { data: { session }, error } = await supabase.auth.setSession(
      JSON.parse(storedSession)
    );
    
    if (error || !session) {
      console.error('[SupabaseClient] ‚ùå Erro ao recarregar sess√£o:', error);
      return false;
    }
    
    console.log('[SupabaseClient] ‚úÖ Token recarregado com sucesso');
    return true;
  } catch (error) {
    console.error('[SupabaseClient] ‚ùå Exce√ß√£o ao recarregar token:', error);
    return false;
  }
};